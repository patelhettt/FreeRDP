name: Ubuntu Tools RDP via Tailscale

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          large-packages: true
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          docker-images: true
          swap-storage: true

      # ----------------------------
      # Create user first
      # ----------------------------
      - name: Create RDP user
        run: |
          PASSWORD=$(openssl rand -base64 12 | tr -dc 'A-Za-z0-9!@#$%^&*()_+' | head -c 16)

          sudo adduser --gecos "" --disabled-password kaliuser
          echo "kaliuser:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo kaliuser

          echo "::add-mask::$PASSWORD"
          echo "RDP_USER=kaliuser" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV

      # ----------------------------
      # Install desktop + tools
      # ----------------------------
      - name: Install XFCE + xRDP + security tools
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            xfce4 xfce4-goodies xorg dbus-x11 x11-xserver-utils \
            xrdp \
            nmap metasploit-framework hashcat john \
            burpsuite aircrack-ng wireshark

          # XFCE for xRDP
          sudo sed -i 's@^exec .*@exec startxfce4@' /etc/xrdp/startwm.sh
          sudo sed -i 's/^new_cursors=true/new_cursors=false/' /etc/xrdp/xrdp.ini || true

          echo "startxfce4" | sudo tee /home/kaliuser/.xsession
          sudo chown kaliuser:kaliuser /home/kaliuser/.xsession
          sudo chmod +x /home/kaliuser/.xsession

          sudo systemctl enable xrdp xrdp-sesman
          sudo systemctl restart xrdp xrdp-sesman

      # ----------------------------
      # Tailscale
      # ----------------------------
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-rdp
          args: --hostname=gh-rdp-${{ github.run_id }}

      - name: Show info
        run: |
          TS_IP=$(tailscale ip -4)
          echo ""
          echo "=== RDP ACCESS ==="
          echo "Address : $TS_IP"
          echo "Username: ${{ env.RDP_USER }}"
          echo "Password: (hidden in logs)"
          echo "Desktop : XFCE"
          echo "==============="
          echo ""

          while true; do
            echo "[$(date)] Session active"
            sleep 300
          done

name: Kali RDP via Tailscale (Docker)

on:
  workflow_dispatch:

jobs:
  kali-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      # ----------------------------
      # Free disk space
      # ----------------------------
      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          large-packages: true
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          docker-images: true
          swap-storage: true

      # ----------------------------
      # Install Docker
      # ----------------------------
      - name: Install Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io
          sudo systemctl start docker
          sudo systemctl enable docker

      # ----------------------------
      # Generate RDP password
      # ----------------------------
      - name: Generate credentials
        run: |
          PASS=$(openssl rand -base64 18 | tr -dc 'A-Za-z0-9!@#$%^&*()_+' | head -c 16)
          echo "::add-mask::$PASS"
          echo "RDP_PASS=$PASS" >> $GITHUB_ENV

      # ----------------------------
      # Build Kali RDP image
      # ----------------------------
      - name: Build Kali RDP image
        run: |
          cat << 'EOF' > Dockerfile
          FROM kalilinux/kali-rolling

          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && apt-get install -y \
              kali-linux-headless \
              xfce4 xfce4-goodies \
              xrdp dbus-x11 xorg sudo \
              && rm -rf /var/lib/apt/lists/*

          RUN useradd -m -s /bin/bash kaliuser \
              && echo "kaliuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

          EXPOSE 3389

          CMD service dbus start && \
              service xrdp start && \
              tail -f /var/log/xrdp.log
          EOF

          docker build -t kali-rdp .

      # ----------------------------
      # Run Kali container
      # ----------------------------
      - name: Start Kali container
        run: |
          docker run -d \
            --name kali-rdp \
            -p 127.0.0.1:3389:3389 \
            kali-rdp

      # ----------------------------
      # Set password inside container
      # ----------------------------
      - name: Set RDP password
        run: |
          docker exec kali-rdp bash -c "echo 'kaliuser:${RDP_PASS}' | chpasswd"

      # ----------------------------
      # Connect to Tailscale
      # ----------------------------
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-kali
          args: --hostname=gh-kali-${{ github.run_id }}

      # ----------------------------
      # Show connection info
      # ----------------------------
      - name: Show connection details
        run: |
          TS_IP=$(tailscale ip -4)

          echo ""
          echo "=============================="
          echo "   REAL KALI RDP IS READY"
          echo "=============================="
          echo "Address : $TS_IP"
          echo "Port    : 3389"
          echo "Username: kaliuser"
          echo "Password: (hidden in logs)"
          echo "Desktop : XFCE"
          echo "=============================="
          echo ""

          while true; do
            echo "[$(date)] Kali RDP active"
            sleep 300
          done
